#!/usr/bin/env node
const { program } = require("commander");
const figlet = require("figlet");
const versionStr = figlet.textSync("QBlog");
const Printer = require("@darkobits/lolcatjs");
const shell = require("shelljs");
let json2ts = require("json2ts");
const _version = require("../package.json").version;
const chalk = require("chalk");
const inquirer = require("inquirer");
const ora = require("ora");
const download = require("download-git-repo");
const util = require("./util");
program.version(
  Printer.default.fromString(
    `   \n      vuepressåšå®¢è„šæ‰‹æ¶${_version}       \n${versionStr}`
  )
);
program.option("create", "åˆ›å»ºé¡¹ç›®");
program.option("test", "æµ‹è¯•å‘½ä»¤");
const step = [
  chalk.green("â‘  ğŸ’Œ è¯·è¾“å…¥é¡¹ç›®åç§°ï¼š"),
  chalk.green(
    "â‘¡ è¯·è¾“å…¥é¡¹ç›®Gitåœ°å€ï¼Œä¸å¡«åˆ™åç»­éœ€è¦è‡ªè¡Œä¿®æ”¹ä»£ç ä»¥å°†åšå®¢å‘å¸ƒåˆ°Gitçº¿ä¸Š\n"
  ) + chalk.yellow("å¦‚ï¼šhttps://github.com/qyunchao/vuepress-blogï¼š"),
];
const bindHandler = {
  create(otherParmas) {
    inquirer
      .prompt([
        {
          type: "text",
          message: step[0],
          name: "dirname",
        },
        {
          type: "text",
          message: step[1],
          name: "giturl",
        },
      ])
      .then((answers) => {
        // console.log(answers.dirname);
        // éªŒè¯è¾“å…¥
        if (!answers.dirname || answers.dirname.length <= 0) {
          console.log(
            chalk.red("æœªè¾“å…¥é¡¹ç›®åï¼Œå°†ä»¥é»˜è®¤é¡¹ç›®å HelloBlog è¿›è¡Œåˆ›å»º")
          );
          answers.dirname = "HelloBlog";
        }
        const _pwd = shell.pwd().stdout;
        const projectPath = `${_pwd}/${answers.dirname}`;
        // console.log("ç”¨æˆ·çš„å…¨è·¯å¾„", projectPath, answers.giturl);
        shell.rm("-rf", projectPath);
        shell.mkdir(projectPath);
        const spinner = ora("â° downloading template.....");
        spinner.start();
        const template = "direct:https://github.com/qyunchao/vuepress-blog.git";
        download(template, projectPath, { clone: true }, function (err) {
          spinner.stop();
          if (err) {
            console.log(chalk.red("ä¸‹è½½å¤±è´¥ğŸ˜­"));
          } else {
            shell.sed(
              "-i",
              "vuepress-blog",
              answers.dirname,
              projectPath + "/package.json"
            );
            if (util.checkGitUrl(answers.giturl)) {
              let gitInfo = util.parseGitUrl(answers.giturl);
              gitInfo.oldStr.map((str, index) => {
                let fileObj = shell.exec(`grep ${str} -rl ${projectPath}/`);
                let fileArr = fileObj.stdout.split("\n");
                fileArr.pop();
                shell.sed("-i", str, gitInfo.newStr[index], fileArr);
              });
            } else {
              console.log(
                chalk.red(
                  "æœªè¾“å…¥æ­£ç¡®é¡¹ç›®åœ°å€ï¼Œè¯·å‚è€ƒ https://vuepress.vuejs.org/zh/guide/deploy.html#github-pages è‡ªè¡Œé…ç½®éƒ¨ç½²ç›¸å…³å†…å®¹"
                )
              );
            }
            console.log(chalk.green("âˆš é¡¹ç›®åˆ›å»ºæˆåŠŸ"));
          }
        });
      });
  },
  test(params) {
    console.log("è·å–åˆ°æµ‹è¯•å‚æ•°ï¼š" + params);
  },
};
program
  .usage("[cmd] <options>")
  .arguments("<cmd> [env]")
  .action(function (cmd, otherParmas) {
    const handler = bindHandler[cmd];
    if (typeof handler === "undefined") {
      console.log(
        chalk.red("å‘½ä»¤ ") + chalk.blue(`${cmd}`) + chalk.red(" æš‚æœªæ”¯æŒ")
      );
    } else {
      handler(otherParmas);
    }
    // console.log('cmd', cmd);
    // console.log('otherParmas', otherParmas);
  });
program.parse(process.argv);
